name: Keep Alive - Cantinho do Caruru

on:
  schedule:
    # Roda a cada 6 horas (00:00, 06:00, 12:00, 18:00 UTC)
    # Streamlit hiberna após 12h sem tráfego real — 6h dá folga segura
    - cron: "0 */6 * * *"
  workflow_dispatch: # Permite executar manualmente no GitHub

jobs:
  wake-up:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Cache Playwright Chromium
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-chromium-${{ runner.os }}-v1

      - name: Instalar Playwright (Chromium)
        run: |
          pip install playwright
          playwright install chromium --with-deps
        if: steps.playwright-cache.outputs.cache-hit != 'true'

      - name: Registrar binários do Playwright (cache hit)
        run: pip install playwright
        if: steps.playwright-cache.outputs.cache-hit == 'true'

      - name: Acordar o App com sessão real
        run: |
          python3 -c "
          from playwright.sync_api import sync_playwright

          url = 'https://radbrse-caruru-app-coa4y5.streamlit.app/'

          with sync_playwright() as p:
              browser = p.chromium.launch()
              page = browser.new_page()

              print('Acessando Cantinho do Caruru...')
              page.goto(url, wait_until='domcontentloaded', timeout=60000)

              # Aguarda o Streamlit carregar e estabelecer a conexão WebSocket
              page.wait_for_selector('[data-testid=\"stApp\"]', timeout=60000)

              # Mantém a sessão aberta por 30 segundos para garantir o registro
              page.wait_for_timeout(30000)

              print('App acordado! Titulo:', page.title())
              browser.close()
          "
