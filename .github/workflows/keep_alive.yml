name: Keep Alive - Cantinho do Caruru

on:
  schedule:
    # Roda a cada 6 horas (00:00, 06:00, 12:00, 18:00 UTC)
    # Streamlit hiberna após 12h sem tráfego real — 6h dá folga segura
    - cron: "0 */6 * * *"
  workflow_dispatch: # Permite executar manualmente no GitHub

jobs:
  wake-up:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Cache Playwright Chromium
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-chromium-${{ runner.os }}-v1

      - name: Instalar Playwright (Chromium)
        run: |
          pip install playwright
          playwright install chromium --with-deps
        if: steps.playwright-cache.outputs.cache-hit != 'true'

      - name: Registrar binários do Playwright (cache hit)
        run: pip install playwright
        if: steps.playwright-cache.outputs.cache-hit == 'true'

      - name: Acordar o App com sessão real
        run: |
          python3 << 'PYEOF'
          from playwright.sync_api import sync_playwright

          url = 'https://radbrse-caruru-app-coa4y5.streamlit.app/'

          with sync_playwright() as p:
              browser = p.chromium.launch()
              page = browser.new_page()

              print('Acessando Cantinho do Caruru...')
              page.goto(url, wait_until='domcontentloaded', timeout=60000)

              # Se o app estiver hibernando, Streamlit mostra uma tela com botão para acordá-lo
              try:
                  wake_btn = page.wait_for_selector(
                      'button:has-text("Yes, get this app back up")',
                      timeout=8000
                  )
                  print('App hibernado detectado. Clicando para acordar...')
                  wake_btn.click()
              except Exception:
                  print('App ja estava ativo (sem tela de hibernacao).')

              # Aguarda o Streamlit carregar completamente — timeout maior para cold start
              print('Aguardando stApp ficar visivel...')
              page.wait_for_selector('[data-testid="stApp"]', timeout=180000)

              # Mantém a sessão aberta para garantir o registro como tráfego real
              print('stApp visivel! Mantendo sessao por 30s...')
              page.wait_for_timeout(30000)

              print('App acordado! Titulo:', page.title())
              browser.close()
          PYEOF
